<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Attendance Management - Online Attendance</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="js/auth.js"></script>
</head>
<body>
  <!-- Glassmorphic top navigation -->
  <header class="app-header">
    <div class="app-header-inner">
      <div class="brand">
        <div class="brand-icon">AMS</div>
        <div class="brand-text">
          <span class="brand-title">Attendance Management</span>
          <span class="brand-subtitle">Online Attendance</span>
        </div>
      </div>
      <nav class="nav-primary" aria-label="Primary navigation">
        <a href="index.html" class="nav-pill">
          <span class="nav-pill-icon">üîë</span>
          <span class="nav-pill-label">Login</span>
        </a>
        <a href="dashboard.html" class="nav-pill">
          <span class="nav-pill-icon">üìä</span>
          <span class="nav-pill-label">Dashboard</span>
        </a>
        <a href="students.html" class="nav-pill">
          <span class="nav-pill-icon">üë®‚Äçüéì</span>
          <span class="nav-pill-label">Students</span>
        </a>
        <a href="attendance.html" class="nav-pill active">
          <span class="nav-pill-icon">‚úÖ</span>
          <span class="nav-pill-label">Attendance</span>
        </a>
        <a href="reports.html" class="nav-pill">
          <span class="nav-pill-icon">üìë</span>
          <span class="nav-pill-label">Reports</span>
        </a>
      </nav>
    </div>
  </header>

  <main class="attendance-main">
    <!-- Page header -->
    <section class="card glass attendance-header">
      <div class="attendance-header-title">
        <span class="attendance-header-icon">üìÖ</span>
        <div>
          <h1>Attendance Management</h1>
          <p class="attendance-header-subtitle">Create sessions and mark attendance for the selected class.</p>
        </div>
      </div>
    </section>

    <section class="attendance-grid">
      <!-- Mark Attendance -->
      <section class="card glass attendance-card attendance-card-wide" id="markAttendanceCard">
        <header class="attendance-card-header">
          <div>
            <h2><span class="attendance-card-icon">‚úîÔ∏è</span>Mark Attendance</h2>
            <p class="attendance-card-subtitle">Select class and session, then mark students present or absent.</p>
          </div>
          <div class="attendance-card-divider"></div>
        </header>

        <div class="attendance-filters">
          <label>
            <span>Class</span>
            <select id="attendanceClass"></select>
          </label>
          <label>
            <span>Session</span>
            <select id="attendanceSession"></select>
          </label>
        </div>

        <p id="attendanceInfo" class="attendance-info">No session selected.</p>

        <div class="table-wrapper glass-table">
          <table class="attendance-table">
            <thead>
              <tr>
                <th>Present</th>
                <th>Student</th>
                <th>Roll</th>
              </tr>
            </thead>
            <tbody id="attendanceTable"></tbody>
          </table>
        </div>

        <div class="attendance-card-actions attendance-save-actions">
          <button id="saveAttendance" class="btn-pill" disabled>
            <span class="btn-pill-icon">üíæ</span>
            <span>Save Attendance</span>
          </button>
        </div>
        <p id="attendanceMessage" class="message"></p>
      </section>
    </section>
  </main>

  <script>
    let currentSessionId = null;
    let currentClassId = null;
    let currentSessions = [];

    (function enforceRole() {
      const auth = getAuth();
      if (!auth || !auth.user) {
        window.location.href = 'index.html';
        return;
      }

      const role = auth.user.role;
      // Only teachers can access the attendance marking page
      if (role !== 'teacher') {
        if (role === 'admin') {
          window.location.href = 'admin-dashboard.html';
        } else if (role === 'student') {
          window.location.href = 'student-dashboard.html';
        } else {
          window.location.href = 'index.html';
        }
      }
    })();

    async function fetchClasses() {
      const res = await authFetch('/api/classes');
      const classes = await res.json();
      return Array.isArray(classes) ? classes : [];
    }

    async function loadClasses() {
      const classes = await fetchClasses();
      const classSel = document.getElementById('attendanceClass');
      if (!classSel) return;
      classSel.innerHTML = '';
      classes.forEach(function (c) {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        classSel.appendChild(opt);
      });

      const initialClassId = classSel.value || (classes[0] && classes[0].id);
      if (initialClassId) {
        classSel.value = String(initialClassId);
        await loadSessionsForClass(initialClassId);
      }
    }

    async function loadSessionsForClass(classId) {
      const sessionSel = document.getElementById('attendanceSession');
      const infoEl = document.getElementById('attendanceInfo');
      const tbody = document.getElementById('attendanceTable');
      const saveBtn = document.getElementById('saveAttendance');
      if (!sessionSel || !infoEl || !tbody || !saveBtn) return;

      sessionSel.innerHTML = '';
      tbody.innerHTML = '';
      currentSessions = [];
      currentSessionId = null;
      currentClassId = classId || null;
      saveBtn.disabled = true;

      if (!classId) {
        infoEl.textContent = 'No class selected.';
        return;
      }

      try {
        const res = await authFetch('/api/sessions?class_id=' + encodeURIComponent(classId));
        const sessions = await res.json();
        currentSessions = Array.isArray(sessions) ? sessions : [];

        if (currentSessions.length === 0) {
          infoEl.textContent = 'No sessions found for the selected class.';
          return;
        }

        const placeholder = document.createElement('option');
        placeholder.value = '';
        placeholder.textContent = 'Select a session';
        sessionSel.appendChild(placeholder);

        currentSessions.forEach(function (s) {
          const label = s.date + (s.topic ? ' - ' + s.topic : '');
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = label;
          sessionSel.appendChild(opt);
        });

        infoEl.textContent = 'Select a session to load students.';
      } catch (err) {
        console.error(err);
        infoEl.textContent = 'Failed to load sessions.';
      }
    }

    async function loadStudentsForClass(classId, sessionId = null) {
      const tbody = document.getElementById('attendanceTable');
      const saveBtn = document.getElementById('saveAttendance');
      if (!tbody || !saveBtn) return;

      tbody.innerHTML = '';
      saveBtn.disabled = true;

      if (!classId) return;

      try {
        // Load students
        const res = await authFetch('/api/students?class_id=' + encodeURIComponent(classId));
        const students = await res.json();
        
        // Load existing attendance if session is selected
        let existingAttendance = {};
        if (sessionId) {
          try {
            const attendanceRes = await authFetch('/api/attendance/by-session?session_id=' + encodeURIComponent(sessionId));
            if (attendanceRes.ok) {
              const attendanceRecords = await attendanceRes.json();
              if (Array.isArray(attendanceRecords)) {
                attendanceRecords.forEach(function (rec) {
                  if (rec.student_id) {
                    existingAttendance[rec.student_id] = rec.status;
                  }
                });
              }
            }
          } catch (attendanceErr) {
            console.warn('Failed to load existing attendance:', attendanceErr);
            // Continue without existing attendance - default to all present
          }
        }
        
        // Create table rows with correct checkbox states
        (students || []).forEach(function (s) {
          const tr = document.createElement('tr');
          const isPresent = existingAttendance[s.id] ? (existingAttendance[s.id].toLowerCase() === 'present') : true;
          const checkboxHtml = '<input type="checkbox" data-student-id="' + s.id + '"' + (isPresent ? ' checked' : '') + ' />';
          tr.innerHTML = '<td>' + checkboxHtml + '</td>' +
            '<td>' + s.name + '</td>' +
            '<td>' + (s.roll_number || '') + '</td>';
          tbody.appendChild(tr);
        });
        saveBtn.disabled = !students || students.length === 0;
      } catch (err) {
        console.error('Failed to load students:', err);
        const msgEl = document.getElementById('attendanceMessage');
        if (msgEl) {
          msgEl.textContent = 'Failed to load students.';
          msgEl.classList.add('error');
        }
      }
    }

    document.getElementById('attendanceClass').addEventListener('change', async function (e) {
      const classId = e.target.value;
      await loadSessionsForClass(classId);
    });

    document.getElementById('attendanceSession').addEventListener('change', async function (e) {
      const sessionId = e.target.value;
      const infoEl = document.getElementById('attendanceInfo');
      const tbody = document.getElementById('attendanceTable');
      const saveBtn = document.getElementById('saveAttendance');

      if (!sessionId) {
        currentSessionId = null;
        if (tbody) tbody.innerHTML = '';
        if (saveBtn) saveBtn.disabled = true;
        if (infoEl) infoEl.textContent = 'No session selected.';
        return;
      }

      currentSessionId = parseInt(sessionId, 10);
      const classSel = document.getElementById('attendanceClass');
      currentClassId = classSel ? classSel.value : null;

      const sessionMeta = currentSessions.find(function (s) { return String(s.id) === String(sessionId); });
      if (sessionMeta) {
        infoEl.textContent = 'Session #' + sessionMeta.id + ' for class ' + sessionMeta.class_id + ' on ' + sessionMeta.date;
      } else {
        infoEl.textContent = 'Session #' + sessionId;
      }

      await loadStudentsForClass(currentClassId, currentSessionId);
    });

    document.getElementById('saveAttendance').addEventListener('click', async function () {
      if (!currentSessionId) {
        const msgEl = document.getElementById('attendanceMessage');
        msgEl.textContent = 'Please select a session first';
        msgEl.classList.add('error');
        return;
      }

      const checkboxes = document.querySelectorAll('input[data-student-id]');
      const records = [];
      
      checkboxes.forEach(function (cb) {
        const student_id = parseInt(cb.getAttribute('data-student-id'), 10);
        if (isNaN(student_id) || student_id <= 0) {
          console.warn('Skipping invalid student_id');
          return;
        }
        const status = cb.checked ? 'present' : 'absent';
        records.push({ student_id: student_id, status: status });
      });

      if (records.length === 0) {
        const msgEl = document.getElementById('attendanceMessage');
        msgEl.textContent = 'No valid students to mark attendance for';
        msgEl.classList.add('error');
        return;
      }

      const msgEl = document.getElementById('attendanceMessage');
      msgEl.textContent = '';
      msgEl.classList.remove('error', 'success');

      // Show loading state
      const saveBtn = document.getElementById('saveAttendance');
      const originalText = saveBtn.innerHTML;
      saveBtn.disabled = true;
      saveBtn.innerHTML = '<span class="btn-pill-icon">‚è≥</span><span>Saving...</span>';

      try {
        const res = await authFetch('/api/attendance', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ session_id: currentSessionId, records: records })
        });

        if (!res.ok) {
          const data = await res.json();
          msgEl.textContent = data.error || 'Failed to save attendance';
          msgEl.classList.add('error');
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalText;
          return;
        }

        const data = await res.json();
        msgEl.textContent = data.message || 'Attendance saved successfully';
        msgEl.classList.add('success');
        
        // Reset button after short delay
        setTimeout(() => {
          saveBtn.disabled = false;
          saveBtn.innerHTML = originalText;
        }, 2000);
      } catch (err) {
        console.error(err);
        msgEl.textContent = 'Network error: ' + (err.message || 'Unknown error');
        msgEl.classList.add('error');
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalText;
      }
    });

    (async function () {
      await loadClasses();
    })();
  </script>
</body>
</html>
