<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Reports - Online Attendance</title>
  <link rel="stylesheet" href="css/style.css" />
  <script src="js/auth.js"></script>
</head>
<body>
  <!-- Top glassmorphic navigation -->
  <header class="app-header">
    <div class="app-header-inner">
      <div class="brand">
        <div class="brand-icon">AMS</div>
        <div class="brand-text">
          <span class="brand-title">Reports</span>
          <span class="brand-subtitle">Attendance insights & exports</span>
        </div>
      </div>
      <nav class="nav-primary" aria-label="Primary navigation">
        <!-- Nav items will be populated dynamically based on role. -->
      </nav>
    </div>
  </header>

  <main class="reports-main">
    <!-- Header card -->
    <section class="card glass reports-header">
      <div class="reports-header-title">
        <span class="reports-header-icon">üìë</span>
        <div>
          <h1>Attendance Reports</h1>
          <p class="reports-header-subtitle">Generate student-wise and class-wise attendance summaries.</p>
        </div>
      </div>
    </section>

    <section class="reports-grid">
      <!-- Student Report Card -->
      <section class="card glass reports-card" id="studentReportSection">
        <header class="reports-card-header">
          <div>
            <h2><span class="reports-card-icon">üë®‚Äçüéì</span>Student Report</h2>
            <p class="reports-card-subtitle">Select a class and student to view detailed attendance.</p>
          </div>
          <div class="reports-card-divider"></div>
        </header>

        <div class="reports-filters">
          <label class="reports-filter">
            <span>Class</span>
            <select id="reportClassForStudent"></select>
          </label>
          <label class="reports-filter">
            <span>Student</span>
            <select id="reportStudent"></select>
          </label>
          <div class="reports-filter actions">
            <button id="loadStudentReport" class="btn-pill">
              <span class="btn-pill-icon">üìÑ</span>
              <span>Load Report</span>
            </button>
          </div>
        </div>

        <div class="reports-downloads">
          <button id="downloadStudentCsv" class="btn-pill">
            <span class="btn-pill-icon">üì•</span>
            <span>Excel (CSV)</span>
          </button>
          <button id="downloadStudentPdf" class="btn-pill">
            <span class="btn-pill-icon">üìÑ</span>
            <span>PDF</span>
          </button>
        </div>

        <div class="table-wrapper glass-table">
          <table class="students-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Class</th>
                <th>Topic</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="studentReportTable"></tbody>
          </table>
        </div>
      </section>

      <!-- Class Summary Card -->
      <section class="card glass reports-card" id="classSummarySection">
        <header class="reports-card-header">
          <div>
            <h2><span class="reports-card-icon">üè´</span>Class Summary</h2>
            <p class="reports-card-subtitle">View attendance summary by class and export results.</p>
          </div>
          <div class="reports-card-divider"></div>
        </header>

        <div class="reports-filters">
          <label class="reports-filter">
            <span>Class</span>
            <select id="summaryClass"></select>
          </label>
          <div class="reports-filter actions">
            <button id="loadClassSummary" class="btn-pill">
              <span class="btn-pill-icon">üìä</span>
              <span>Load Summary</span>
            </button>
          </div>
        </div>

        <div class="reports-downloads">
          <button id="downloadClassCsv" class="btn-pill">
            <span class="btn-pill-icon">üì•</span>
            <span>Excel (CSV)</span>
          </button>
          <button id="downloadClassPdf" class="btn-pill">
            <span class="btn-pill-icon">üìÑ</span>
            <span>PDF</span>
          </button>
        </div>

        <div class="table-wrapper glass-table">
          <table class="students-table">
            <thead>
              <tr>
                <th>Student</th>
                <th>Roll</th>
                <th>Presents</th>
                <th>Total</th>
                <th>% Present</th>
              </tr>
            </thead>
            <tbody id="classSummaryTable"></tbody>
          </table>
        </div>
      </section>
    </section>
  </main>

  <script>

    const auth = getAuth();
    if (!auth || !auth.user) {
      window.location.href = 'index.html';
    }

    const currentRole = auth && auth.user ? auth.user.role : null;

    // Build a role-based navigation bar for this page.
    (function configureRoleBasedNav() {
      const nav = document.querySelector('.nav-primary');
      if (!nav) return;
      nav.innerHTML = '';

      function createNavLink(href, icon, label, isActive) {
        const a = document.createElement('a');
        a.href = href;
        a.className = 'nav-pill' + (isActive ? ' active' : '');

        const iconSpan = document.createElement('span');
        iconSpan.className = 'nav-pill-icon';
        iconSpan.textContent = icon;

        const labelSpan = document.createElement('span');
        labelSpan.className = 'nav-pill-label';
        labelSpan.textContent = label;

        a.appendChild(iconSpan);
        a.appendChild(labelSpan);
        nav.appendChild(a);
      }

      function createLogoutButton() {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'nav-pill';

        const iconSpan = document.createElement('span');
        iconSpan.className = 'nav-pill-icon';
        iconSpan.textContent = 'üö™';

        const labelSpan = document.createElement('span');
        labelSpan.className = 'nav-pill-label';
        labelSpan.textContent = 'Logout';

        btn.appendChild(iconSpan);
        btn.appendChild(labelSpan);

        btn.addEventListener('click', function () {
          logout(); // Uses shared logout function from auth.js
        });

        nav.appendChild(btn);
      }

      if (currentRole === 'admin') {
        createNavLink('admin-dashboard.html', 'üìä', 'Dashboard', false);
        createNavLink('class-management.html', 'üè´', 'Classes', false);
        createNavLink('teachers.html', 'üë©‚Äçüè´', 'Teachers', false);
        createNavLink('students.html', 'üë®‚Äçüéì', 'Students', false);
        createNavLink('reports.html', 'üìë', 'Reports', true);
        createNavLink('settings.html', '‚öôÔ∏è', 'Settings', false);
        createLogoutButton();
      } else if (currentRole === 'teacher') {
        createNavLink('teacher-dashboard.html', 'üìò', 'Dashboard', false);
        createNavLink('attendance.html', 'üìù', 'Attendance', false);
        createNavLink('reports.html', 'üìë', 'Reports', true);
        createLogoutButton();
      } else if (currentRole === 'student') {
        createNavLink('student-dashboard.html', 'üè†', 'Dashboard', false);
        createNavLink('my-attendance.html', 'üìÖ', 'My Attendance', false);
        createNavLink('reports.html', 'üìë', 'Reports', true);
        createLogoutButton();
      } else {
        // Fallback: minimal nav if role is unknown.
        createNavLink('dashboard.html', 'üìä', 'Dashboard', false);
        createNavLink('reports.html', 'üìë', 'Reports', true);
        createLogoutButton();
      }
    })();

    // Students can only see their own report, not class summaries
    if (currentRole === 'student') {
      const summarySection = document.getElementById('classSummarySection');
      if (summarySection) summarySection.style.display = 'none';
    }


    async function fetchClasses() {
      const res = await authFetch('/api/classes');
      const classes = await res.json();
      return Array.isArray(classes) ? classes : [];
    }

    async function fetchStudentsByClass(classId) {
      if (!classId) return [];
      const res = await authFetch('/api/students?class_id=' + encodeURIComponent(classId));
      const students = await res.json();
      return Array.isArray(students) ? students : [];
    }

    async function loadClassDropdowns() {
      const classes = await fetchClasses();
      const reportClassSel = document.getElementById('reportClassForStudent');
      const summaryClassSel = document.getElementById('summaryClass');
      reportClassSel.innerHTML = '';
      summaryClassSel.innerHTML = '';

      classes.forEach((c) => {
        const opt1 = document.createElement('option');
        opt1.value = c.id;
        opt1.textContent = c.name;
        reportClassSel.appendChild(opt1);

        const opt2 = document.createElement('option');
        opt2.value = c.id;
        opt2.textContent = c.name;
        summaryClassSel.appendChild(opt2);
      });

      // After populating classes, always load students for the currently selected class
      const initialClassId = reportClassSel.value || (classes[0] && classes[0].id);
      if (initialClassId) {
        reportClassSel.value = String(initialClassId);
        await loadStudentsForClassReport(initialClassId);
      } else {
        // No classes: ensure student dropdown is cleared
        const studentSel = document.getElementById('reportStudent');
        studentSel.innerHTML = '';
      }
    }

    async function loadStudentsForClassReport(classId) {
      const students = await fetchStudentsByClass(classId);
      const studentSel = document.getElementById('reportStudent');
      studentSel.innerHTML = '';
      (students || []).forEach((s) => {
        const opt = document.createElement('option');
        opt.value = s.id;
        opt.textContent = `${s.name} (${s.roll_number || 'No roll'})`;
        studentSel.appendChild(opt);
      });
    }

    document.getElementById('reportClassForStudent').addEventListener('change', async (e) => {
      const classId = e.target.value;
      if (!classId) {
        const studentSel = document.getElementById('reportStudent');
        studentSel.innerHTML = '';
        return;
      }
      await loadStudentsForClassReport(classId);
    });

    document.getElementById('loadStudentReport').addEventListener('click', async () => {
      const studentId = document.getElementById('reportStudent').value;
      if (!studentId) {
        alert('Please select a student');
        return;
      }

      const tbody = document.getElementById('studentReportTable');
      tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px;">Loading...</td></tr>';

      try {
        const res = await authFetch('/api/reports/by-student?student_id=' + encodeURIComponent(studentId));
        
        if (!res.ok) {
          const data = await res.json();
          tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">${data.error || 'Failed to load report'}</td></tr>`;
          return;
        }

        const rows = await res.json();
        tbody.innerHTML = '';
        
        if (!Array.isArray(rows) || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No attendance records found</td></tr>';
          return;
        }

        rows.forEach(r => {
          const tr = document.createElement('tr');
          // Use textContent to prevent XSS
          const td1 = document.createElement('td');
          td1.textContent = r.date || '';
          tr.appendChild(td1);
          
          const td2 = document.createElement('td');
          td2.textContent = r.class_name || '';
          tr.appendChild(td2);
          
          const td3 = document.createElement('td');
          td3.textContent = r.topic || '';
          tr.appendChild(td3);
          
          const td4 = document.createElement('td');
          td4.textContent = r.status || '';
          tr.appendChild(td4);
          
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Network error: ' + (err.message || 'Unknown error') + '</td></tr>';
      }
    });

    document.getElementById('loadClassSummary').addEventListener('click', async () => {
      const classId = document.getElementById('summaryClass').value;
      if (!classId) {
        alert('Please select a class');
        return;
      }

      const tbody = document.getElementById('classSummaryTable');
      tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Loading...</td></tr>';

      try {
        const res = await authFetch('/api/reports/summary-by-class?class_id=' + encodeURIComponent(classId));
        
        if (!res.ok) {
          const data = await res.json();
          tbody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">${data.error || 'Failed to load summary'}</td></tr>`;
          return;
        }

        const rows = await res.json();
        tbody.innerHTML = '';
        
        if (!Array.isArray(rows) || rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No data found</td></tr>';
          return;
        }

        rows.forEach(r => {
          const total = r.total || 0;
          const presents = r.presents || 0;
          const percent = total > 0 ? ((presents / total) * 100).toFixed(1) : '0.0';
          
          const tr = document.createElement('tr');
          // Use textContent to prevent XSS
          const cells = [
            r.student_name || '',
            r.roll_number || '',
            String(presents),
            String(total),
            percent + '%'
          ];
          
          cells.forEach(text => {
            const td = document.createElement('td');
            td.textContent = text;
            tr.appendChild(td);
          });
          
          tbody.appendChild(tr);
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Network error: ' + (err.message || 'Unknown error') + '</td></tr>';
      }
    });

    document.getElementById('downloadStudentCsv').addEventListener('click', async () => {
      const currentAuth = getAuth();
      let studentId = null;
      if (currentRole === 'student' && currentAuth && currentAuth.user && currentAuth.user.student_id) {
        studentId = currentAuth.user.student_id;
      } else {
        studentId = document.getElementById('reportStudent').value;
      }
      if (!studentId) {
        alert('Please select a student');
        return;
      }

      try {
        const res = await authFetch(`/api/reports/by-student/export?student_id=${encodeURIComponent(studentId)}&format=csv`);
        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Failed to download');
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `student-${studentId}-report.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert('Download failed: ' + (err.message || 'Unknown error'));
      }
    });

    document.getElementById('downloadStudentPdf').addEventListener('click', async () => {
      const currentAuth = getAuth();
      let studentId = null;
      if (currentRole === 'student' && currentAuth && currentAuth.user && currentAuth.user.student_id) {
        studentId = currentAuth.user.student_id;
      } else {
        studentId = document.getElementById('reportStudent').value;
      }
      if (!studentId) {
        alert('Please select a student');
        return;
      }

      try {
        const res = await authFetch(`/api/reports/by-student/export?student_id=${encodeURIComponent(studentId)}&format=pdf`);
        if (!res.ok) {
          const data = await res.json();
          alert(data.error || 'Failed to download');
          return;
        }
        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `student-${studentId}-report.pdf`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (err) {
        console.error(err);
        alert('Download failed: ' + (err.message || 'Unknown error'));
      }
    });

    const downloadClassButtonsVisible = document.getElementById('classSummarySection').style.display !== 'none';
    if (downloadClassButtonsVisible) {
      document.getElementById('downloadClassCsv').addEventListener('click', async () => {
        const classId = document.getElementById('summaryClass').value;
        if (!classId) {
          alert('Please select a class');
          return;
        }

        try {
          const res = await authFetch(`/api/reports/summary-by-class/export?class_id=${encodeURIComponent(classId)}&format=csv`);
          if (!res.ok) {
            const data = await res.json();
            alert(data.error || 'Failed to download');
            return;
          }
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `class-${classId}-summary.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          alert('Download failed: ' + (err.message || 'Unknown error'));
        }
      });

      document.getElementById('downloadClassPdf').addEventListener('click', async () => {
        const classId = document.getElementById('summaryClass').value;
        if (!classId) {
          alert('Please select a class');
          return;
        }

        try {
          const res = await authFetch(`/api/reports/summary-by-class/export?class_id=${encodeURIComponent(classId)}&format=pdf`);
          if (!res.ok) {
            const data = await res.json();
            alert(data.error || 'Failed to download');
            return;
          }
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `class-${classId}-summary.pdf`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (err) {
          console.error(err);
          alert('Download failed: ' + (err.message || 'Unknown error'));
        }
      });
    }

    (async () => {
      // For students, auto-load their own report if we know their student_id
      if (currentRole === 'student' && auth && auth.user && auth.user.student_id) {
        try {
          const res = await authFetch('/api/reports/by-student?student_id=' + encodeURIComponent(auth.user.student_id));
          if (!res.ok) {
            const data = await res.json();
            const tbody = document.getElementById('studentReportTable');
            tbody.innerHTML = `<tr><td colspan="4" style="text-align: center; color: red;">${data.error || 'Failed to load report'}</td></tr>`;
            return;
          }
          const rows = await res.json();
          const tbody = document.getElementById('studentReportTable');
          tbody.innerHTML = '';
          
          if (!Array.isArray(rows) || rows.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">No attendance records found</td></tr>';
            return;
          }
          
          rows.forEach(r => {
            const tr = document.createElement('tr');
            // Use textContent to prevent XSS
            const td1 = document.createElement('td');
            td1.textContent = r.date || '';
            tr.appendChild(td1);
            const td2 = document.createElement('td');
            td2.textContent = r.class_name || '';
            tr.appendChild(td2);
            const td3 = document.createElement('td');
            td3.textContent = r.topic || '';
            tr.appendChild(td3);
            const td4 = document.createElement('td');
            td4.textContent = r.status || '';
            tr.appendChild(td4);
            tbody.appendChild(tr);
          });
        } catch (err) {
          console.error(err);
          const tbody = document.getElementById('studentReportTable');
          tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: red;">Network error: ' + (err.message || 'Unknown error') + '</td></tr>';
        }
      } else {
        await loadClassDropdowns();
      }
    })();
  </script>
</body>
</html>
